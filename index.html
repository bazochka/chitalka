<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ğ§Ğ¸Ñ‚Ğ°Ğ»ĞºĞ°">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#12100e">
<title>Ğ§Ğ¸Ñ‚Ğ°Ğ»ĞºĞ°</title>

<!-- PWA Manifest inline -->
<script>
const manifestData = {
  name: "Ğ§Ğ¸Ñ‚Ğ°Ğ»ĞºĞ°",
  short_name: "Ğ§Ğ¸Ñ‚Ğ°Ğ»ĞºĞ°",
  description: "Ğ§Ğ¸Ñ‚Ğ°Ğ»ĞºĞ° ĞºĞ½Ğ¸Ğ³ Ñ Ğ¾Ğ·Ğ²ÑƒÑ‡ĞºĞ¾Ğ¹",
  start_url: "./",
  display: "standalone",
  background_color: "#12100e",
  theme_color: "#12100e",
  orientation: "portrait",
  icons: [
    { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' rx='32' fill='%2312100e'/><text y='130' x='96' text-anchor='middle' font-size='120'>ğŸ“–</text></svg>", sizes: "192x192", type: "image/svg+xml" },
    { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='80' fill='%2312100e'/><text y='360' x='256' text-anchor='middle' font-size='320'>ğŸ“–</text></svg>", sizes: "512x512", type: "image/svg+xml" }
  ]
};
const blob = new Blob([JSON.stringify(manifestData)], {type:'application/json'});
const manifestUrl = URL.createObjectURL(blob);
document.write(`<link rel="manifest" href="${manifestUrl}">`);
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:          #12100e;
  --surface:     #1c1914;
  --surface2:    #242019;
  --border:      #38322a;
  --text:        #e8dcc8;
  --text-dim:    #8c7d6a;
  --accent:      #c9a84c;
  --accent-dark: #a07830;
  --hl:          rgba(201,168,76,.16);
  --reading-bg:  #181510;
  --reading-text:#ddd0b8;
  --fd:          'Playfair Display', Georgia, serif;
  --fb:          'Crimson Pro', Georgia, serif;
  --safe-top:    env(safe-area-inset-top, 0px);
  --safe-bot:    env(safe-area-inset-bottom, 0px);
  --safe-left:   env(safe-area-inset-left, 0px);
  --safe-right:  env(safe-area-inset-right, 0px);
  --topbar-h:    56px;
  --botbar-h:    72px;
  --fs:          20px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { height: 100%; overscroll-behavior: none; }
body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: var(--fb);
  font-size: 16px;
  overflow: hidden;
  touch-action: pan-y;
  -webkit-font-smoothing: antialiased;
}
button { font-family: var(--fb); cursor: pointer; border: none; background: none; color: inherit; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOP BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#topbar {
  height: calc(var(--topbar-h) + var(--safe-top));
  padding-top: var(--safe-top);
  padding-left: calc(12px + var(--safe-left));
  padding-right: calc(12px + var(--safe-right));
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
  z-index: 30;
}
#topbar-title {
  flex: 1;
  font-family: var(--fd);
  font-size: 15px;
  font-style: italic;
  color: var(--text-dim);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.tb-btn {
  width: 40px; height: 40px;
  border-radius: 10px;
  border: 1px solid var(--border);
  color: var(--text-dim);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  transition: background .15s, color .15s;
  flex-shrink: 0;
}
.tb-btn:active { background: var(--hl); color: var(--accent); }
.tb-btn.lit { color: var(--accent); border-color: var(--accent); background: var(--hl); }
#progress-pill {
  font-size: 11px;
  color: var(--text-dim);
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 3px 9px;
  flex-shrink: 0;
  font-variant-numeric: tabular-nums;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   READING AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#reading-wrap {
  flex: 1;
  overflow: hidden;
  position: relative;
  background: var(--reading-bg);
}
#reading-area {
  position: absolute;
  inset: 0;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
  padding: 28px calc(20px + var(--safe-left)) 28px calc(20px + var(--safe-right));
}
#reading-area::-webkit-scrollbar { display: none; }

/* swipe animation */
#reading-area.slide-left  { animation: slideLeft  .22s ease forwards; }
#reading-area.slide-right { animation: slideRight .22s ease forwards; }
@keyframes slideLeft  { from { opacity:1; transform:translateX(0);    } to { opacity:0; transform:translateX(-40px); } }
@keyframes slideRight { from { opacity:1; transform:translateX(0);    } to { opacity:0; transform:translateX(40px);  } }
#reading-area.arrive-left  { animation: arriveLeft  .22s ease forwards; }
#reading-area.arrive-right { animation: arriveRight .22s ease forwards; }
@keyframes arriveLeft  { from { opacity:0; transform:translateX(40px);  } to { opacity:1; transform:translateX(0); } }
@keyframes arriveRight { from { opacity:0; transform:translateX(-40px); } to { opacity:1; transform:translateX(0); } }

#content {
  font-family: var(--fb);
  font-size: var(--fs);
  line-height: 1.85;
  color: var(--reading-text);
  max-width: 640px;
  margin: 0 auto;
}
#content h1, #content h2, #content h3 {
  font-family: var(--fd);
  color: var(--text);
  margin: 1.8em 0 .6em;
  line-height: 1.3;
}
#content h1 { font-size: 1.6em; font-style: italic; }
#content h2 { font-size: 1.3em; }
#content h3 { font-size: 1.1em; }
#content p  { margin-bottom: .9em; text-align: justify; hyphens: auto; }
#content img { max-width: 100%; border-radius: 6px; margin: 1em 0; display: block; }
#content a   { color: var(--accent); text-decoration: none; }
#content blockquote { border-left: 3px solid var(--accent-dark); padding-left: 14px; color: var(--text-dim); margin: 1em 0; font-style: italic; }

/* TTS highlight */
.tts-s { border-radius: 3px; transition: background .2s; }
.tts-s.on { background: var(--hl); outline: 1px solid rgba(201,168,76,.3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM PLAYER BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#player {
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding-bottom: var(--safe-bot);
  flex-shrink: 0;
  z-index: 30;
}
/* thin progress strip */
#prog-strip {
  width: 100%; height: 3px;
  background: var(--border);
  position: relative;
  cursor: pointer;
  touch-action: none;
}
#prog-fill { height: 100%; background: var(--accent); border-radius: 0; pointer-events: none; transition: width .3s; }
#prog-dot {
  position: absolute;
  top: 50%; transform: translate(-50%,-50%);
  width: 14px; height: 14px;
  background: var(--accent);
  border-radius: 50%;
  pointer-events: none;
  box-shadow: 0 0 0 3px var(--surface);
  transition: left .3s;
}

#player-inner {
  display: flex;
  align-items: center;
  padding: 10px 16px;
  gap: 8px;
}
/* Play button â€” big, thumb-friendly */
#play-btn {
  width: 56px; height: 56px;
  border-radius: 50%;
  background: var(--accent);
  color: #12100e;
  font-size: 22px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  transition: transform .15s, background .15s;
  box-shadow: 0 4px 16px rgba(201,168,76,.25);
}
#play-btn:active { transform: scale(.92); background: #dab84e; }

/* Prev / Next */
#prev-btn, #next-btn {
  width: 48px; height: 48px;
  border-radius: 12px;
  border: 1px solid var(--border);
  color: var(--text-dim);
  font-size: 20px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  transition: background .15s, color .15s;
}
#prev-btn:active, #next-btn:active { background: var(--hl); color: var(--text); }

/* chapter info in player */
#player-chapter {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}
#player-ch-title {
  font-family: var(--fd);
  font-size: 13px;
  font-style: italic;
  color: var(--text-dim);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#player-ch-num {
  font-size: 11px;
  color: var(--text-dim);
  opacity: .6;
}

/* Speed pill */
#speed-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text-dim);
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 12px;
  flex-shrink: 0;
  transition: all .15s;
}
#speed-btn:active { color: var(--accent); border-color: var(--accent); background: var(--hl); }
#wake-btn {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; padding: 6px 10px; font-size: 16px;
  flex-shrink: 0; transition: all .15s;
  opacity: 0.45;
}
#wake-btn.active { opacity: 1; border-color: var(--accent); background: var(--hl); }
#wake-btn:active { opacity: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAWER (TOC + Settings)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#drawer-backdrop {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.6);
  z-index: 40;
  opacity: 0; pointer-events: none;
  transition: opacity .3s;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
#drawer-backdrop.show { opacity: 1; pointer-events: all; }

#drawer {
  position: fixed;
  left: 0; bottom: 0; right: 0;
  max-height: 82vh;
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  z-index: 50;
  display: flex; flex-direction: column;
  transform: translateY(100%);
  transition: transform .35s cubic-bezier(.32,0,.67,0);
  overflow: hidden;
}
#drawer.open { transform: translateY(0); transition-timing-function: cubic-bezier(.33,1,.68,1); }
.drawer-handle {
  width: 36px; height: 4px;
  background: var(--border);
  border-radius: 2px;
  margin: 10px auto 0;
  flex-shrink: 0;
}
.drawer-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  padding: 0 16px;
  margin-top: 8px;
}
.dtab {
  flex: 1;
  padding: 10px 0;
  font-size: 13px;
  color: var(--text-dim);
  text-align: center;
  border-bottom: 2px solid transparent;
  transition: all .2s;
  letter-spacing: .03em;
}
.dtab.active { color: var(--accent); border-bottom-color: var(--accent); }

.drawer-panel { display: none; flex-direction: column; overflow: hidden; flex: 1; }
.drawer-panel.active { display: flex; }

/* TOC */
#toc-book-title {
  padding: 12px 20px 6px;
  font-family: var(--fd);
  font-size: 14px;
  font-style: italic;
  color: var(--text-dim);
  flex-shrink: 0;
}
#toc-list {
  overflow-y: auto;
  flex: 1;
  -webkit-overflow-scrolling: touch;
}
.toc-item {
  padding: 14px 20px;
  font-size: 15px;
  color: var(--text-dim);
  border-left: 2px solid transparent;
  line-height: 1.4;
  transition: all .15s;
  /* big touch target */
  min-height: 52px;
  display: flex;
  align-items: center;
}
.toc-item:active { background: var(--surface2); }
.toc-item.active { color: var(--accent); border-left-color: var(--accent); background: var(--hl); }

/* SETTINGS PANEL */
#settings-panel {
  padding: 16px 20px;
  overflow-y: auto;
  flex: 1;
  gap: 20px;
  display: flex;
  flex-direction: column;
}
.setting-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.setting-label { font-size: 15px; color: var(--text); }
.setting-sub   { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

/* Font size control */
.fs-control { display: flex; align-items: center; gap: 12px; }
.fs-btn {
  width: 40px; height: 40px;
  border-radius: 10px;
  border: 1px solid var(--border);
  color: var(--text-dim);
  font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
}
.fs-btn:active { background: var(--hl); color: var(--accent); }
#fs-val { font-size: 15px; color: var(--text); min-width: 26px; text-align: center; }

/* Speed selector */
.speed-chips { display: flex; gap: 8px; flex-wrap: wrap; }
.sc {
  padding: 8px 16px;
  border-radius: 10px;
  border: 1px solid var(--border);
  font-size: 14px;
  color: var(--text-dim);
  transition: all .15s;
  min-height: 40px;
  display: flex; align-items: center; justify-content: center;
}
.sc:active { background: var(--hl); }
.sc.active { background: var(--hl); color: var(--accent); border-color: var(--accent); }

/* Voice selector */
#voice-sel {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 10px;
  padding: 10px 12px;
  font-family: var(--fb);
  font-size: 14px;
  width: 100%;
  appearance: none;
  -webkit-appearance: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DROP / LANDING SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#landing {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
  background: var(--reading-bg);
  z-index: 5;
  padding: 32px 24px;
  text-align: center;
}
#landing.gone { display: none; }
.land-icon { font-size: 72px; line-height: 1; }
.land-title { font-family: var(--fd); font-size: 30px; font-style: italic; color: var(--text); }
.land-sub { font-size: 15px; color: var(--text-dim); line-height: 1.7; }
.land-formats { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: -4px; }
.fmt { background: var(--surface); border: 1px solid var(--border); color: var(--text-dim); font-size: 12px; padding: 4px 10px; border-radius: 20px; font-family: monospace; }
.land-btn {
  background: var(--accent);
  color: #12100e;
  border: none;
  padding: 16px 40px;
  border-radius: 16px;
  font-family: var(--fd);
  font-size: 18px;
  width: 100%;
  max-width: 320px;
  transition: transform .15s, background .15s;
  margin-top: 4px;
}
.land-btn:active { transform: scale(.97); background: #dab84e; }
.land-hint { font-size: 12px; color: var(--text-dim); opacity: .7; }
.land-hint a { color: var(--accent); }

/* PWA install banner */
#install-banner {
  display: none;
  align-items: center;
  gap: 12px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px 16px;
  max-width: 340px;
  width: 100%;
  text-align: left;
}
#install-banner.show { display: flex; }
.install-icon { font-size: 28px; flex-shrink: 0; }
.install-text { flex: 1; font-size: 13px; color: var(--text-dim); line-height: 1.5; }
.install-text strong { color: var(--text); display: block; margin-bottom: 2px; }
#install-btn {
  background: var(--accent);
  color: #12100e;
  border-radius: 8px;
  padding: 8px 14px;
  font-size: 13px;
  flex-shrink: 0;
}
#install-btn:active { background: #dab84e; }
#install-close {
  position: absolute;
  top: 8px; right: 8px;
  font-size: 16px;
  color: var(--text-dim);
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
}
#install-banner { position: relative; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESTORE TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#restore-toast {
  position: absolute;
  bottom: 16px; left: 16px; right: 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px 16px;
  z-index: 20;
  display: none;
  align-items: center;
  gap: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,.5);
  animation: slideUp .3s ease;
}
#restore-toast.show { display: flex; }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.rt-text { flex: 1; font-size: 13px; color: var(--text-dim); line-height: 1.4; }
.rt-text strong { color: var(--text); display: block; }
.rt-yes { background: var(--accent); color: #12100e; border-radius: 8px; padding: 8px 14px; font-size: 13px; flex-shrink: 0; }
.rt-no  { color: var(--text-dim); font-size: 13px; padding: 8px; flex-shrink: 0; }
.rt-yes:active { background: #dab84e; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loading {
  display: none;
  position: fixed; inset: 0;
  background: rgba(18,16,14,.9);
  z-index: 80;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
}
#loading.show { display: flex; }
.spinner { width: 40px; height: 40px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
#load-txt { font-size: 14px; color: var(--text-dim); }
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SWIPE HINT (first time)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#swipe-hint {
  display: none;
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(28,25,20,.9);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 8px 18px;
  font-size: 13px;
  color: var(--text-dim);
  pointer-events: none;
  z-index: 15;
  animation: fadeHint 2.5s ease forwards;
  white-space: nowrap;
}
@keyframes fadeHint { 0%{opacity:0} 20%{opacity:1} 70%{opacity:1} 100%{opacity:0} }
</style>
</head>
<body>
<div id="app">

  <!-- TOP BAR -->
  <div id="topbar">
    <button class="tb-btn" id="toc-btn" title="ĞĞ³Ğ»Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ">â˜°</button>
    <div id="topbar-title">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¸Ğ³Ñƒ</div>
    <div id="progress-pill">0%</div>
    <button class="tb-btn" id="settings-btn" title="ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸">âš™</button>
  </div>

  <!-- READING AREA -->
  <div id="reading-wrap">
    <!-- LANDING -->
    <div id="landing">
      <div class="land-icon">ğŸ“–</div>
      <div class="land-title">Ğ§Ğ¸Ñ‚Ğ°Ğ»ĞºĞ°</div>
      <div class="land-sub">Ğ§Ğ¸Ñ‚Ğ°Ğ¹Ñ‚Ğµ ĞºĞ½Ğ¸Ğ³Ğ¸ Ğ²ÑĞ»ÑƒÑ….<br>ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹:</div>
      <div class="land-formats">
        <span class="fmt">EPUB</span><span class="fmt">FB2</span><span class="fmt">TXT</span><span class="fmt">RTF</span><span class="fmt">MOBI</span>
      </div>
      <label for="file-input" class="land-btn" style="display:flex;align-items:center;justify-content:center;cursor:pointer;">ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ĞºĞ½Ğ¸Ğ³Ñƒ</label>
      <div class="land-hint">Ğ¸Ğ»Ğ¸ Ğ¿ĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğ° ÑĞºÑ€Ğ°Ğ½</div>

      <div id="install-banner">
        <div class="install-icon">ğŸ“²</div>
        <div class="install-text">
          <strong>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ ÑĞºÑ€Ğ°Ğ½</strong>
          Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½ ĞºĞ°Ğº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
        </div>
        <button id="install-btn">Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
        <button id="install-close">âœ•</button>
      </div>
    </div>

    <!-- CONTENT -->
    <div id="reading-area">
      <div id="content" style="display:none">
        <div id="chapter-content"></div>
      </div>
    </div>

    <!-- RESTORE TOAST -->
    <div id="restore-toast">
      <div class="rt-text">
        <strong>ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ?</strong>
        <span id="rt-chapter"></span>
      </div>
      <button class="rt-no"  id="rt-no">ĞĞµÑ‚</button>
      <button class="rt-yes" id="rt-yes">Ğ”Ğ°</button>
    </div>

    <!-- SWIPE HINT -->
    <div id="swipe-hint">â† ÑĞ²Ğ°Ğ¹Ğ¿ Ğ´Ğ»Ñ Ğ»Ğ¸ÑÑ‚Ğ°Ğ½Ğ¸Ñ Ğ³Ğ»Ğ°Ğ² â†’</div>
  </div>

  <!-- PLAYER BAR -->
  <div id="player" style="display:none">
    <div id="prog-strip">
      <div id="prog-fill" style="width:0%"></div>
      <div id="prog-dot"  style="left:0%"></div>
    </div>
    <div id="player-inner">
      <button id="prev-btn">â€¹</button>
      <button id="play-btn">â–¶</button>
      <button id="next-btn">â€º</button>
      <div id="player-chapter">
        <div id="player-ch-title">â€”</div>
        <div id="player-ch-num"></div>
      </div>
      <button id="speed-btn">1Ã—</button>
      <button id="wake-btn" title="ĞĞµ Ğ³Ğ°ÑĞ¸Ñ‚ÑŒ ÑĞºÑ€Ğ°Ğ½">â˜€ï¸</button>
    </div>
  </div>

  <div id="offline-badge" style="display:none;position:fixed;top:calc(env(safe-area-inset-top,0px) + 60px);right:12px;background:#242019;border:1px solid #38322a;border-radius:20px;padding:4px 12px;font-size:12px;color:#8c7d6a;z-index:35;">ğŸ“µ ĞÑ„Ğ»Ğ°Ğ¹Ğ½</div>
  <div id="ios-hint" style="display:none;position:fixed;bottom:100px;left:16px;right:16px;background:#1c1914;border:1px solid #38322a;border-radius:14px;padding:14px;font-size:13px;color:#8c7d6a;line-height:1.5;z-index:100;text-align:center;">ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ <strong style="color:#e8dcc8">ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ</strong> â†’ <strong style="color:#e8dcc8">ĞĞ° ÑĞºÑ€Ğ°Ğ½ Â«Ğ”Ğ¾Ğ¼Ğ¾Ğ¹Â»</strong> Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ°Ğº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ <button onclick="this.parentNode.classList.remove('show');localStorage.setItem('ios_hint','1')" style="display:block;margin:10px auto 0;background:#c9a84c;color:#12100e;border:none;border-radius:8px;padding:6px 16px;font-size:13px;cursor:pointer;">ĞŸĞ¾Ğ½ÑÑ‚Ğ½Ğ¾</button></div>
</div><!-- #app -->

<!-- DRAWER -->
<div id="drawer-backdrop"></div>
<div id="drawer">
  <div class="drawer-handle"></div>
  <div class="drawer-tabs">
    <button class="dtab active" data-tab="toc">ĞĞ³Ğ»Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ</button>
    <button class="dtab" data-tab="settings">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</button>
  </div>

  <!-- TOC PANEL -->
  <div class="drawer-panel active" id="dp-toc">
    <div id="toc-book-title"></div>
    <div id="toc-list"></div>
  </div>

  <!-- SETTINGS PANEL -->
  <div class="drawer-panel" id="dp-settings">
    <div id="settings-panel">

      <div>
        <div class="setting-label">Ğ Ğ°Ğ·Ğ¼ĞµÑ€ ÑˆÑ€Ğ¸Ñ„Ñ‚Ğ°</div>
        <div style="margin-top:10px;">
          <div class="fs-control">
            <button class="fs-btn" id="fs-dec">Aâˆ’</button>
            <span id="fs-val">20</span>
            <button class="fs-btn" id="fs-inc">A+</button>
          </div>
        </div>
      </div>

      <div>
        <div class="setting-label">Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ</div>
        <div style="margin-top:10px;">
          <div class="speed-chips" id="speed-chips">
            <button class="sc active" data-sp="1">1Ã—</button>
            <button class="sc" data-sp="1.25">1.25Ã—</button>
            <button class="sc" data-sp="1.5">1.5Ã—</button>
            <button class="sc" data-sp="2">2Ã—</button>
          </div>
        </div>
      </div>

      <div>
        <div class="setting-label">Ğ“Ğ¾Ğ»Ğ¾Ñ</div>
        <div class="setting-sub">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ğ¾Ğ»Ğ¾Ñ Ğ´Ğ»Ñ Ğ¾Ğ·Ğ²ÑƒÑ‡ĞºĞ¸</div>
        <select id="voice-sel" style="margin-top:10px;"></select>
      </div>

    </div>
  </div>
</div>

<!-- LOADING -->
<div id="loading">
  <div class="spinner"></div>
  <div id="load-txt">Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ĞºĞ½Ğ¸Ğ³Ñƒâ€¦</div>
</div>

<input type="file" id="file-input" accept="*/*" style="display:none">

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $  = id => document.getElementById(id);
const $fi = () => $('file-input');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  bookId: null,
  chapters: [],
  idx: 0,
  tts: { on: false, sidx: 0, speed: 1, voice: null },
  fs: 20,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOM REFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const landing      = $('landing');
const readingArea  = $('reading-area');
const content      = $('content');
const chCont       = $('chapter-content');
const player       = $('player');
const playBtn      = $('play-btn');
const prevBtn      = $('prev-btn');
const nextBtn      = $('next-btn');
const progFill     = $('prog-fill');
const progDot      = $('prog-dot');
const progStrip    = $('prog-strip');
const progressPill = $('progress-pill');
const topbarTitle  = $('topbar-title');
const playerChTitle= $('player-ch-title');
const playerChNum  = $('player-ch-num');
const speedBtn     = $('speed-btn');
const tocList      = $('toc-list');
const tocBookTitle = $('toc-book-title');
const drawer       = $('drawer');
const drawerBg     = $('drawer-backdrop');
const loadingEl    = $('loading');
const loadTxt      = $('load-txt');
const restoreToast = $('restore-toast');
const swipeHint    = $('swipe-hint');
const voiceSel     = $('voice-sel');
const fsVal        = $('fs-val');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDrawer(tab = 'toc') {
  drawer.classList.add('open');
  drawerBg.classList.add('show');
  switchTab(tab);
}
function closeDrawer() {
  drawer.classList.remove('open');
  drawerBg.classList.remove('show');
}
function switchTab(tab) {
  document.querySelectorAll('.dtab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.drawer-panel').forEach(p => p.classList.toggle('active', p.id === `dp-${tab}`));
}
document.querySelectorAll('.dtab').forEach(t => t.onclick = () => switchTab(t.dataset.tab));
drawerBg.onclick = closeDrawer;
$('toc-btn').onclick      = () => openDrawer('toc');
$('settings-btn').onclick = () => openDrawer('settings');

// Drawer drag-to-close
let dStartY = 0, dCurY = 0, dDragging = false;
drawer.addEventListener('touchstart', e => { dStartY = e.touches[0].clientY; dDragging = true; }, { passive:true });
drawer.addEventListener('touchmove', e => {
  if (!dDragging) return;
  dCurY = e.touches[0].clientY;
  const dy = Math.max(0, dCurY - dStartY);
  drawer.style.transform = `translateY(${dy}px)`;
}, { passive:true });
drawer.addEventListener('touchend', () => {
  dDragging = false;
  const dy = dCurY - dStartY;
  drawer.style.transform = '';
  if (dy > 80) closeDrawer();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE OPEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFile(file) {
  loadingEl.classList.add('show');
  loadTxt.textContent = 'Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼â€¦';
  try {
    const n = file.name.toLowerCase();
    if (n.endsWith('.epub'))            await loadEpub(file);
    else if (n.endsWith('.fb2'))        await loadFb2(file);
    else if (n.endsWith('.txt'))        await loadTxt2(file);
    else if (n.endsWith('.rtf'))        await loadRtf(file);
    else if (n.endsWith('.mobi')||n.endsWith('.azw')||n.endsWith('.azw3')) await loadMobi(file);
    else throw new Error('ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: ' + file.name);
  } catch(e) {
    console.error(e);
    loadingEl.classList.remove('show');
    alert('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ:\n' + e.message);
    return;
  }
  loadingEl.classList.remove('show');
}

function finalizeBook(title) {
  S.bookId = btoa(encodeURIComponent(title)).replace(/[^a-zA-Z0-9]/g,'').substring(0,24);
  document.title = title + ' â€” Ğ§Ğ¸Ñ‚Ğ°Ğ»ĞºĞ°';
  tocBookTitle.textContent = title;
  renderToc();

  const saved = loadProg();
  S.idx = (saved?.idx ?? 0);
  if (S.idx >= S.chapters.length) S.idx = 0;

  landing.classList.add('gone');
  content.style.display = 'block';
  player.style.display  = 'block';

  renderChapter(S.idx, false);

  if (saved && saved.idx > 0 && saved.idx < S.chapters.length) {
    $('rt-chapter').textContent = S.chapters[saved.idx]?.title || '';
    restoreToast.classList.add('show');
    setTimeout(() => restoreToast.classList.remove('show'), 8000);
  }

  // Show swipe hint once
  if (!localStorage.getItem('swipe_shown')) {
    setTimeout(() => { swipeHint.style.display='block'; setTimeout(()=>{ swipeHint.style.display='none'; }, 3000); }, 1200);
    localStorage.setItem('swipe_shown','1');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EPUB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadEpub(file) {
  loadTxt.textContent = 'Ğ Ğ°Ğ·Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ EPUBâ€¦';
  const zip = await JSZip.loadAsync(file);
  const containerXml = await zip.file('META-INF/container.xml').async('string');
  const containerDoc = new DOMParser().parseFromString(containerXml, 'application/xml');
  const opfPath = containerDoc.querySelector('rootfile').getAttribute('full-path');
  const opfDir  = opfPath.includes('/') ? opfPath.substring(0, opfPath.lastIndexOf('/')+1) : '';
  const opfXml  = await zip.file(opfPath).async('string');
  const opfDoc  = new DOMParser().parseFromString(opfXml, 'application/xml');
  const bookTitle = opfDoc.querySelector('title')?.textContent?.trim() || file.name.replace(/\.epub$/i,'');

  const manifest = {};
  opfDoc.querySelectorAll('manifest item').forEach(item => {
    manifest[item.getAttribute('id')] = { href: item.getAttribute('href') };
  });
  const spine = [...opfDoc.querySelectorAll('spine itemref')].map(r=>manifest[r.getAttribute('idref')]?.href).filter(Boolean);

  let toc = [];
  const navId = opfDoc.querySelector('manifest item[properties~="nav"]')?.getAttribute('id');
  if (navId && manifest[navId]) {
    const navXml = await zip.file(opfDir + manifest[navId].href)?.async('string');
    if (navXml) toc = parseNavToc(new DOMParser().parseFromString(navXml,'text/html'), manifest[navId].href);
  }
  if (!toc.length) {
    const ncxId = opfDoc.querySelector('spine')?.getAttribute('toc');
    const ncxHref = ncxId && manifest[ncxId]?.href;
    if (ncxHref) {
      const ncxXml = await zip.file(opfDir+ncxHref)?.async('string');
      if (ncxXml) toc = parseNcxToc(new DOMParser().parseFromString(ncxXml,'application/xml'));
    }
  }

  S.chapters = [];
  for (let i=0;i<spine.length;i++) {
    const href = spine[i];
    const fullPath = opfDir+href;
    const f = zip.file(fullPath)||zip.file(href);
    if (!f) continue;
    const html = await f.async('string');
    const tmpDoc = new DOMParser().parseFromString(html, 'text/html');
    const tocMatch = toc.find(t=>t.href&&href.includes(t.href.split('#')[0]));
    const h1 = tmpDoc.querySelector('h1,h2,h3,title')?.textContent?.trim()||'';
    for (const img of [...tmpDoc.querySelectorAll('img')]) {
      const src = img.getAttribute('src');
      if (!src||src.startsWith('data:')) continue;
      const ip = resolveRel(fullPath,src);
      const ifile = zip.file(ip);
      if (ifile) {
        const data = await ifile.async('base64');
        const ext  = ip.split('.').pop().toLowerCase();
        const mime = {jpg:'jpeg',jpeg:'jpeg',png:'png',gif:'gif',webp:'webp',svg:'svg+xml'}[ext]||'jpeg';
        img.setAttribute('src',`data:image/${mime};base64,${data}`);
      }
    }
    tmpDoc.body.querySelectorAll('script,style').forEach(el=>el.remove());
    S.chapters.push({id:i, title:tocMatch?.label||h1||`Ğ Ğ°Ğ·Ğ´ĞµĞ» ${i+1}`, href, content:tmpDoc.body.innerHTML});
  }
  toc.forEach(t=>{
    const ch=S.chapters.find(c=>c.href&&t.href&&c.href.includes(t.href.split('#')[0]));
    if(ch&&t.label) ch.title=t.label;
  });
  finalizeBook(bookTitle);
}
function resolveRel(base,rel) {
  const p=base.split('/');p.pop();
  for(const pt of rel.split('/')) { if(pt==='..') p.pop(); else if(pt!=='.') p.push(pt); }
  return p.join('/');
}
function parseNavToc(navDoc,navHref) {
  const toc=[],navDir=navHref.includes('/')?navHref.substring(0,navHref.lastIndexOf('/')+1):'';
  navDoc.querySelectorAll('nav a, nav li a').forEach(a=>{
    const label=a.textContent.trim(),href=a.getAttribute('href');
    if(label&&href) toc.push({label,href:navDir+href});
  });
  return toc;
}
function parseNcxToc(ncxDoc) {
  const toc=[];
  ncxDoc.querySelectorAll('navPoint').forEach(np=>{
    const label=np.querySelector('navLabel text')?.textContent?.trim();
    const href=np.querySelector('content')?.getAttribute('src');
    if(label&&href) toc.push({label,href});
  });
  return toc;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FB2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFb2(file) {
  loadTxt.textContent = 'Ğ Ğ°Ğ·Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ FB2â€¦';
  let text;
  try { text = await readAs(file,'text'); }
  catch(e) { text = new TextDecoder('windows-1251').decode(await readAs(file,'arraybuffer')); }
  const parser = new DOMParser();
  const doc = parser.parseFromString(text,'application/xml');
  if (doc.querySelector('parsererror')) return loadFb2Doc(parser.parseFromString(text,'text/html'), file.name);
  return loadFb2Doc(doc, file.name);
}
function loadFb2Doc(doc, fn) {
  const titleEl = doc.querySelector('book-title')||doc.querySelector('title');
  const authorEl= doc.querySelector('author');
  const firstName=authorEl?.querySelector('first-name')?.textContent?.trim()||'';
  const lastName =authorEl?.querySelector('last-name')?.textContent?.trim()||'';
  const author   =[firstName,lastName].filter(Boolean).join(' ');
  const bookTitle=titleEl?.textContent?.trim()||fn.replace(/\.fb2$/i,'');
  const fullTitle=author?`${bookTitle} â€” ${author}`:bookTitle;
  const imageMap={};
  doc.querySelectorAll('binary').forEach(bin=>{
    const id=bin.getAttribute('id'),mime=bin.getAttribute('content-type')||'image/jpeg';
    const data=bin.textContent.trim().replace(/\s/g,'');
    if(id) imageMap['#'+id]=`data:${mime};base64,${data}`;
  });
  S.chapters=[];
  const bodies=[...doc.querySelectorAll('body')];
  if(!bodies.length) throw new Error('FB2: Ğ½ĞµÑ‚ Ñ‚ĞµĞ»Ğ°');
  bodies.forEach((body,bi)=>{
    const sections=body.querySelectorAll(':scope > section');
    if(!sections.length) {
      const html=fb2ToHtml(body,imageMap);
      if(html.trim()) S.chapters.push({id:S.chapters.length,title:body.querySelector('title')?.textContent?.trim()||bookTitle,content:html});
    } else {
      sections.forEach((sec,si)=>{
        const title2=sec.querySelector(':scope > title')?.textContent?.trim()||`Ğ Ğ°Ğ·Ğ´ĞµĞ» ${si+1}`;
        const html=fb2ToHtml(sec,imageMap);
        if(html.trim()) S.chapters.push({id:S.chapters.length,title:title2,content:html});
      });
    }
  });
  if(!S.chapters.length) throw new Error('FB2: Ñ‚ĞµĞºÑÑ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
  finalizeBook(fullTitle);
}
function fb2ToHtml(node,im) {
  let h='';
  for(const c of node.childNodes) {
    if(c.nodeType===3){h+=esc(c.textContent);continue;}
    if(c.nodeType!==1) continue;
    const t=c.tagName?.toLowerCase();
    if(t==='title') h+=`<h2>${fb2ToHtml(c,im)}</h2>`;
    else if(t==='subtitle') h+=`<h3>${fb2ToHtml(c,im)}</h3>`;
    else if(t==='p') h+=`<p>${fb2ToHtml(c,im)}</p>`;
    else if(t==='empty-line') h+='<br>';
    else if(t==='strong') h+=`<strong>${fb2ToHtml(c,im)}</strong>`;
    else if(t==='emphasis') h+=`<em>${fb2ToHtml(c,im)}</em>`;
    else if(t==='epigraph'||t==='cite') h+=`<blockquote>${fb2ToHtml(c,im)}</blockquote>`;
    else if(t==='poem'||t==='stanza') h+=`<div style="white-space:pre-line;font-style:italic;margin:1em 0">${fb2ToHtml(c,im)}</div>`;
    else if(t==='v') h+=fb2ToHtml(c,im)+'\n';
    else if(t==='image'){
      const href=c.getAttribute('href')||c.getAttribute('l:href')||c.getAttributeNS('http://www.w3.org/1999/xlink','href');
      const src=im[href];if(src)h+=`<img src="${src}">`;
    }
    else h+=fb2ToHtml(c,im);
  }
  return h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTxt2(file) {
  loadTxt.textContent = 'Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ TXTâ€¦';
  let text;
  try { text = await readAs(file,'text'); }
  catch(e) { text = new TextDecoder('windows-1251').decode(await readAs(file,'arraybuffer')); }
  const bookTitle = file.name.replace(/\.txt$/i,'');
  const lines = text.split(/\r?\n/);
  const headRe = /^(Ğ³Ğ»Ğ°Ğ²Ğ°|chapter|Ñ‡Ğ°ÑÑ‚ÑŒ|part|Ñ€Ğ°Ğ·Ğ´ĞµĞ»|section|ĞºĞ½Ğ¸Ğ³Ğ°|book)\s+[\dIVXivxĞ-Ğ¯Ğ°-Ñ]+/i;
  const chapters=[];let cur={title:bookTitle,lines:[]};
  for(const line of lines){
    if(headRe.test(line.trim())&&line.trim()){
      if(cur.lines.some(l=>l.trim())) chapters.push(cur);
      cur={title:line.trim(),lines:[]};
    } else cur.lines.push(line);
  }
  if(cur.lines.some(l=>l.trim())) chapters.push(cur);
  if(chapters.length<=1) {
    S.chapters=splitPages(text,bookTitle);
  } else {
    S.chapters=chapters.map((ch,i)=>({id:i,title:ch.title,content:txtHtml(ch.lines.join('\n'))}));
  }
  finalizeBook(bookTitle);
}
function txtHtml(text) {
  return text.split(/\n{2,}/).map(p=>p.trim()).filter(Boolean).map(p=>`<p>${esc(p).replace(/\n/g,'<br>')}</p>`).join('\n');
}
function splitPages(text,title,size=4000){
  const paras=text.split(/\n\n+/);const pages=[];let page='';
  for(const p of paras){page+=`<p>${esc(p.trim())}</p>\n`;if(page.length>=size){pages.push(page);page='';}}
  if(page.trim()) pages.push(page);
  return pages.map((c,i)=>({id:i,title:i===0?title:`Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° ${i+1}`,content:c}));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RTF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRtf(file) {
  loadTxt.textContent = 'Ğ Ğ°Ğ·Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ RTFâ€¦';
  let text;
  try { text = await readAs(file,'text'); }
  catch(e) { text = new TextDecoder('windows-1251').decode(await readAs(file,'arraybuffer')); }
  const bookTitle = file.name.replace(/\.rtf$/i,'');
  S.chapters = splitHtmlChapters(rtfToHtml(text), bookTitle);
  finalizeBook(bookTitle);
}
function rtfToHtml(rtf) {
  let t=rtf;
  t=t.replace(/\\u(-?\d+)\??/g,(_,n)=>{const c=parseInt(n);return String.fromCharCode(c<0?c+65536:c);});
  t=t.replace(/\\'([0-9a-fA-F]{2})/g,(_,h)=>cp1251(parseInt(h,16)));
  t=t.replace(/\\par\b/g,'\n\n');t=t.replace(/\\pard\b/g,'');t=t.replace(/\\line\b/g,'\n');
  t=t.replace(/\\[a-zA-Z]+\-?\d*\s?/g,'');t=t.replace(/\{[^{}]*\}/g,'');t=t.replace(/[{}]/g,'');
  t=t.replace(/\r\n/g,'\n').replace(/\r/g,'\n').replace(/\n{3,}/g,'\n\n').trim();
  return txtHtml(t);
}
function cp1251(b){
  const map='\u0402\u0403\u201A\u0453\u201E\u2026\u2020\u2021\u20AC\u2030\u0409\u2039\u040A\u040C\u040B\u040F\u0452\u2018\u2019\u201C\u201D\u2022\u2013\u2014\ufffd\u2122\u0459\u203A\u045A\u045C\u045B\u045F\u00A0\u040E\u045E\u0408\u00A4\u0490\u00A6\u00A7\u0401\u00A9\u0404\u00AB\u00AC\u00AD\u00AE\u0407\u00B0\u00B1\u0406\u0456\u0491\u00B5\u00B6\u00B7\u0451\u2116\u0454\u00BB\u0458\u0405\u0455\u0457';
  if(b>=0xC0&&b<=0xFF) return String.fromCharCode(0x0410+b-0xC0);
  if(b>=0x80&&b<=0xBF) return map[b-0x80]||String.fromCharCode(b);
  return String.fromCharCode(b);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadMobi(file) {
  loadTxt.textContent = 'Ğ Ğ°Ğ·Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ MOBIâ€¦';
  const buf=await readAs(file,'arraybuffer');
  const bytes=new Uint8Array(buf),view=new DataView(buf);
  const numRec=view.getUint16(76);
  const records=[];
  for(let i=0;i<numRec;i++){
    const off=view.getUint32(78+i*8),nxt=i+1<numRec?view.getUint32(78+(i+1)*8):buf.byteLength;
    records.push({offset:off,length:nxt-off});
  }
  const rec0=new Uint8Array(buf,records[0].offset,records[0].length);
  const r0v=new DataView(buf,records[0].offset,records[0].length);
  const comp=r0v.getUint16(0),numTxt=r0v.getUint16(8);
  const mobiMagic=readAsc(rec0,16,4);
  let enc='windows-1252',title=file.name.replace(/\.(mobi|azw\d?)$/i,'');
  if(mobiMagic==='MOBI'){
    const ec=r0v.getUint32(16+28);if(ec===65001)enc='utf-8';
    const fno=r0v.getUint32(16+84),fnl=r0v.getUint32(16+88);
    if(fnl>0&&fno+fnl<rec0.length) title=new TextDecoder(enc).decode(rec0.slice(fno,fno+fnl));
  }
  const dec=new TextDecoder(enc,{fatal:false});
  let raw='';
  for(let i=1;i<=numTxt&&i<records.length;i++){
    const rec=new Uint8Array(buf,records[i].offset,records[i].length);
    raw+=dec.decode(comp===2?palmDecomp(rec):rec);
  }
  let html=raw.replace(/<mbp:pagebreak\s*\/?>/gi,'<hr>').replace(/<mbp:[^>]+>/gi,'');
  const doc=new DOMParser().parseFromString(html,'text/html');
  doc.querySelectorAll('script,style').forEach(el=>el.remove());
  S.chapters=splitHtmlChapters(doc.body?.innerHTML||'',title);
  finalizeBook(title);
}
function palmDecomp(data){
  const out=[];let i=0;
  while(i<data.length){
    const c=data[i++];
    if(c===0){out.push(0);}
    else if(c<=8){for(let k=0;k<c;k++)out.push(data[i++]);}
    else if(c<=0x7f){out.push(c);}
    else if(c<=0xbf){const n=data[i++],d=((c<<8|n)>>3)&0x7ff,l=(n&7)+3,o=out.length-d;for(let k=0;k<l;k++)out.push(o+k<0?32:(out[o+k]??32));}
    else{out.push(32);out.push(c^0x80);}
  }
  return new Uint8Array(out);
}
function readAsc(b,off,len){let s='';for(let i=off;i<off+len&&i<b.length;i++)s+=String.fromCharCode(b[i]);return s;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARED HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function splitHtmlChapters(html,title) {
  const doc=new DOMParser().parseFromString(`<div>${html}</div>`,'text/html');
  const root=doc.body.firstChild;
  const chapters=[];let cur={title,nodes:[]};
  for(const node of root.childNodes){
    if(node.nodeType===1){
      const tag=node.tagName.toLowerCase();
      if(['h1','h2','h3','hr'].includes(tag)){
        if(cur.nodes.length>0&&cur.nodes.some(n=>n.textContent.trim()))
          chapters.push({...cur,content:cur.nodes.map(n=>n.outerHTML||n.textContent).join('')});
        cur={title:node.textContent.trim()||`Ğ“Ğ»Ğ°Ğ²Ğ° ${chapters.length+1}`,nodes:[]};
      } else cur.nodes.push(node);
    } else if(node.nodeType===3&&node.textContent.trim()) cur.nodes.push(node);
  }
  if(cur.nodes.length>0&&cur.nodes.some(n=>n.textContent.trim()))
    chapters.push({...cur,content:cur.nodes.map(n=>n.outerHTML||n.textContent).join('')});
  if(!chapters.length) return splitPages(root.textContent||'',title);
  const merged=[];
  for(const ch of chapters){
    if(merged.length>0&&ch.content.length<500&&merged[merged.length-1].content.length<3000)
      merged[merged.length-1].content+=ch.content;
    else merged.push(ch);
  }
  return merged.map((ch,i)=>({id:i,title:ch.title,content:ch.content}));
}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function readAs(file,type){
  return new Promise((res,rej)=>{
    const fr=new FileReader();fr.onerror=()=>rej(new Error('ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ'));
    if(type==='text'){fr.onload=()=>res(fr.result);fr.readAsText(file,'utf-8');}
    else{fr.onload=()=>res(fr.result);fr.readAsArrayBuffer(file);}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderToc() {
  tocList.innerHTML='';
  S.chapters.forEach((ch,i)=>{
    const div=document.createElement('div');
    div.className='toc-item';
    div.textContent=ch.title;
    div.onclick=()=>{stopTTS();renderChapter(i,true);closeDrawer();};
    tocList.appendChild(div);
  });
}

function renderChapter(idx, animate=false, dir='right') {
  if(idx<0||idx>=S.chapters.length) return;
  const ch=S.chapters[idx];
  S.idx=idx;

  if(animate && !readingArea.classList.contains('slide-left') && !readingArea.classList.contains('slide-right')) {
    const outClass = dir==='right' ? 'slide-left' : 'slide-right';
    const inClass  = dir==='right' ? 'arrive-left' : 'arrive-right';
    readingArea.classList.add(outClass);
    setTimeout(()=>{
      readingArea.classList.remove(outClass);
      chCont.innerHTML=ch.content;
      wrapSentences();
      readingArea.scrollTo(0,0);
      readingArea.classList.add(inClass);
      setTimeout(()=>readingArea.classList.remove(inClass), 240);
    }, 220);
  } else {
    chCont.innerHTML=ch.content;
    wrapSentences();
    readingArea.scrollTo(0,0);
  }

  // Update UI
  topbarTitle.textContent    = ch.title;
  playerChTitle.textContent  = ch.title;
  playerChNum.textContent    = `${idx+1} / ${S.chapters.length}`;

  // TOC highlight
  document.querySelectorAll('.toc-item').forEach((el,i)=>el.classList.toggle('active',i===idx));
  const activeToc=tocList.querySelector('.toc-item.active');
  if(activeToc) activeToc.scrollIntoView({block:'nearest'});

  updateProgress();
  saveProg();
}

function wrapSentences() {
  chCont.querySelectorAll('p,li,blockquote').forEach(el=>{
    if(el.querySelector('p,li')||!el.textContent.trim()) return;
    const spans=splitSentences(el.textContent);
    if(spans.length<2){
      el.classList.add('tts-s');
      el.onclick=()=>jumpTo(el);
      return;
    }
    const frag=document.createDocumentFragment();
    spans.forEach(s=>{
      if(!s.trim()) return;
      const sp=document.createElement('span');
      sp.className='tts-s';sp.textContent=s;
      sp.onclick=()=>jumpTo(sp);
      frag.appendChild(sp);
    });
    el.innerHTML='';el.appendChild(frag);
  });
}
function splitSentences(t){return t.match(/[^.!?â€¦;]+[.!?â€¦;]+\s*|[^.!?â€¦;]+$/g)||[t];}

function updateProgress() {
  const pct=S.chapters.length>1?Math.round(S.idx/(S.chapters.length-1)*100):0;
  progressPill.textContent=pct+'%';
  progFill.style.width=pct+'%';
  progDot.style.left=pct+'%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSpans(){ return [...chCont.querySelectorAll('.tts-s')]; }

function startTTS(fromIdx=0) {
  if(!window.speechSynthesis){alert('Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ ÑĞ¸Ğ½Ñ‚ĞµĞ· Ñ€ĞµÑ‡Ğ¸');return;}
  stopTTS(false);
  const spans=getSpans();
  if(!spans.length) return;
  S.tts.on=true;S.tts.sidx=fromIdx;
  playBtn.textContent='â¸';

  function next(){
    if(!S.tts.on) return;
    spans.forEach(s=>s.classList.remove('on'));
    const i=S.tts.sidx;
    if(i>=spans.length){
      stopTTS(false);
      if(S.idx+1<S.chapters.length){ renderChapter(S.idx+1,true,'right'); setTimeout(()=>startTTS(0),350); }
      else playBtn.textContent='â–¶';
      return;
    }
    const sp=spans[i];
    sp.classList.add('on');
    sp.scrollIntoView({block:'center',behavior:'smooth'});
    const u=new SpeechSynthesisUtterance(sp.textContent.trim());
    u.rate=S.tts.speed;u.lang=langOf(sp.textContent);
    if(S.tts.voice) u.voice=S.tts.voice;
    u.onend=()=>{if(!S.tts.on)return;S.tts.sidx++;next();};
    u.onerror=e=>{if(e.error==='interrupted')return;S.tts.sidx++;next();};
    window.speechSynthesis.speak(u);
  }
  next();
}
function pauseTTS(){window.speechSynthesis.pause();S.tts.on=false;playBtn.textContent='â–¶';}
function resumeTTS(){
  if(window.speechSynthesis.paused){window.speechSynthesis.resume();S.tts.on=true;playBtn.textContent='â¸';}
  else startTTS(S.tts.sidx);
}
function stopTTS(reset=true){
  window.speechSynthesis.cancel();S.tts.on=false;
  if(reset)S.tts.sidx=0;
  chCont.querySelectorAll('.tts-s').forEach(s=>s.classList.remove('on'));
  playBtn.textContent='â–¶';
}
function jumpTo(span){
  const spans=getSpans(),i=spans.indexOf(span);
  if(i<0) return;
  const was=S.tts.on||window.speechSynthesis.speaking;
  stopTTS(false);S.tts.sidx=i;
  if(was) startTTS(i);
}
function langOf(t){const c=(t.match(/[Ğ°-ÑÑ‘Ğ-Ğ¯Ğ]/g)||[]).length;return c>t.length*.15?'ru-RU':'en-US';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateVoices(){
  const voices=window.speechSynthesis.getVoices();
  voiceSel.innerHTML='';
  const rel=voices.filter(v=>v.lang.startsWith('ru')||v.lang.startsWith('en'));
  if(!rel.length){voiceSel.innerHTML='<option>Ğ“Ğ¾Ğ»Ğ¾Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ</option>';return;}
  const grps={};
  rel.forEach(v=>{const g=v.lang.startsWith('ru')?'ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹':'ğŸ‡¬ğŸ‡§ English';(grps[g]=grps[g]||[]).push(v);});
  Object.entries(grps).forEach(([g,vs])=>{
    const grp=document.createElement('optgroup');grp.label=g;
    vs.forEach(v=>{const o=document.createElement('option');o.value=v.name;o.textContent=v.name;grp.appendChild(o);});
    voiceSel.appendChild(grp);
  });
  const ru=rel.find(v=>v.lang.startsWith('ru')&&v.localService)||rel.find(v=>v.lang.startsWith('ru'));
  if(ru) voiceSel.value=ru.name;
  updateVoice();
}
function updateVoice(){S.tts.voice=window.speechSynthesis.getVoices().find(v=>v.name===voiceSel.value)||null;}
voiceSel.onchange=()=>{updateVoice();if(S.tts.on){const i=S.tts.sidx;startTTS(i);}};
window.speechSynthesis.onvoiceschanged=populateVoices;
populateVoices();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRESS PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveProg(){if(!S.bookId)return;try{localStorage.setItem('rdr_'+S.bookId,JSON.stringify({idx:S.idx,ts:Date.now()}));}catch(e){}}
function loadProg(){if(!S.bookId)return null;try{return JSON.parse(localStorage.getItem('rdr_'+S.bookId));}catch(e){return null;}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FONT SIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFS(s){
  S.fs=Math.max(14,Math.min(32,s));
  fsVal.textContent=S.fs;
  document.documentElement.style.setProperty('--fs',S.fs+'px');
}
$('fs-inc').onclick=()=>setFS(S.fs+1);
$('fs-dec').onclick=()=>setFS(S.fs-1);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const speeds=[1,1.25,1.5,2];let spIdx=0;
document.querySelectorAll('.sc').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.sc').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    S.tts.speed=parseFloat(btn.dataset.sp);
    speedBtn.textContent=btn.textContent;
    if(S.tts.on){const i=S.tts.sidx;startTTS(i);}
  };
});
// Tap speed pill to cycle
speedBtn.onclick=()=>{
  spIdx=(spIdx+1)%speeds.length;
  S.tts.speed=speeds[spIdx];
  const label=speeds[spIdx]+'Ã—';
  speedBtn.textContent=label;
  document.querySelectorAll('.sc').forEach(b=>b.classList.toggle('active',parseFloat(b.dataset.sp)===speeds[spIdx]));
  if(S.tts.on){const i=S.tts.sidx;startTTS(i);}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
playBtn.onclick=()=>{if(!S.chapters.length)return;if(S.tts.on)pauseTTS();else resumeTTS();};
prevBtn.onclick=()=>{stopTTS();if(S.idx>0)renderChapter(S.idx-1,true,'left');};
nextBtn.onclick=()=>{stopTTS();if(S.idx<S.chapters.length-1)renderChapter(S.idx+1,true,'right');};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRESS STRIP DRAG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function seekTo(e) {
  const rect=progStrip.getBoundingClientRect();
  const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left;
  const pct=Math.max(0,Math.min(1,x/rect.width));
  const idx=Math.round(pct*(S.chapters.length-1));
  stopTTS();renderChapter(idx,false);
}
progStrip.addEventListener('click',seekTo);
progStrip.addEventListener('touchstart',seekTo,{passive:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SWIPE GESTURE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tx0=0,ty0=0,swiping=false;
readingArea.addEventListener('touchstart',e=>{
  tx0=e.touches[0].clientX;ty0=e.touches[0].clientY;swiping=true;
},{passive:true});
readingArea.addEventListener('touchend',e=>{
  if(!swiping||!S.chapters.length) return;
  const dx=e.changedTouches[0].clientX-tx0;
  const dy=e.changedTouches[0].clientY-ty0;
  swiping=false;
  if(Math.abs(dx)>Math.abs(dy)*1.5&&Math.abs(dx)>50) {
    if(dx<0 && S.idx<S.chapters.length-1){ stopTTS(); renderChapter(S.idx+1,true,'right'); }
    if(dx>0 && S.idx>0){ stopTTS(); renderChapter(S.idx-1,true,'left'); }
  }
},{passive:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('file-input').onchange=e=>{const f=e.target.files[0];if(f)loadFile(f);e.target.value='';};

// Drag & drop onto reading area
document.body.addEventListener('dragover',e=>e.preventDefault());
document.body.addEventListener('drop',e=>{e.preventDefault();const f=e.dataTransfer.files[0];if(f)loadFile(f);});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESTORE TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('rt-yes').onclick=()=>restoreToast.classList.remove('show');
$('rt-no').onclick=()=>{restoreToast.classList.remove('show');stopTTS();renderChapter(0,false);};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD (desktop fallback)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName))return;
  if(e.code==='Space'){e.preventDefault();playBtn.click();}
  if(e.code==='ArrowRight') nextBtn.click();
  if(e.code==='ArrowLeft')  prevBtn.click();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA INSTALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();deferredPrompt=e;
  $('install-banner').classList.add('show');
});
$('install-btn').onclick=async()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  const r=await deferredPrompt.userChoice;
  deferredPrompt=null;
  $('install-banner').classList.remove('show');
};
$('install-close').onclick=()=>$('install-banner').classList.remove('show');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVICE WORKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(reg => {
    console.log('SW registered:', reg.scope);
  }).catch(err => console.log('SW error:', err));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OFFLINE DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateOnline(){document.getElementById('offline-badge').classList.toggle('show',!navigator.onLine);}
window.addEventListener('online', updateOnline);
window.addEventListener('offline', updateOnline);
updateOnline();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IOS INSTALL HINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent) && !window.MSStream;
const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode:standalone)').matches;
if(isIOS && !isStandalone && !localStorage.getItem('ios_hint')) {
  setTimeout(() => {
    const hint = document.getElementById('ios-hint');
    if(hint) hint.classList.add('show');
  }, 2000);
}

// Init font size
setFS(20);
</script>
</body>
</html>
